<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Checkin</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css"
    />

    <style>
      header {
          margin: 50px 0;
      }

      nav {
          display: flex;
          width: 100%;
      }

      nav a {
          margin: 0 10px;
      }
      #scan-table {
        margin-top: 20px;
        border-collapse: collapse;
        width: 100%;
      }

      #scan-table th,
      #scan-table td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
      }

      #input-form {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        align-items: baseline;
      }

      #input-form label {
        min-width: 115px;
        margin-right: 10px;
      }

      #input-form select {
        width: 200px; /* Anpassen der Breite nach Bedarf */
        box-sizing: border-box;
      }

      #input-form button {
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>NAK Campus Checkin</h1>
      <hr>
      <nav>
          <a href="realtime_scans.html">Realtime Scans</a>
          <span style="flex: auto;flex-grow: 1;"></span>
          <a href="https://h2949706.stratoserver.net/_" target="_blank">Admin</a>
      </nav>
      <hr>
  </header>

    <!-- Form for input -->
    <form id="input-form">
      <label for="date">Abfragedatum:</label>
      <input type="date" id="date">

      <label for="startTime">Abfragestart:</label>
      <input type="time" id="startTime" name="startTime">

      <label for="endTime">Abfrageende:</label>
      <input type="time" id="endTime" name="endTime">

      <label for="endTime">Vorlesungsstart:</label>
      <input type="time" id="lesson_start" name="lesson_start">

      <label for="raum">Raumnummer:</label>
      <select id="raum" name="raum">
      </select>

      <button id="submitButton">Submit</button>

    </form>

    <table id="scan-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Matrikelnummer</th>
          <th>Checkin Time</th>
          <th>Versp√§tung in Minuten</th>
        </tr>
      </thead>
      <tbody id="scan-list"></tbody>
    </table>

    <template id="scan-template">
      <tr>
        <td class="name"></td>
        <td class="matr_nr"></td>
        <td class="checkin_time"></td>
        <td class="lateness"></td>
      </tr>
    </template>

    <script type="module">
      import PocketBase from "https://unpkg.com/pocketbase@0.19.0/dist/pocketbase.es.mjs";

      const pb = new PocketBase("https://h2949706.stratoserver.net");

      const scanTemplate = document.getElementById("scan-template"),
        scanList = document.getElementById("scan-list"),
        submitButton = document.getElementById("submitButton");

      submitButton.addEventListener("click", async function(event){
        event.preventDefault();
        scanList.innerHTML = '';

        const date = document.getElementById("date").value;
        const startTime = document.getElementById("startTime").value;
        const endTime = document.getElementById("endTime").value;
        const lesson_start = document.getElementById("lesson_start").value;
        const raum = document.getElementById("raum").value;

        try {
            const records = await pb
              .collection("card_scans")
              .getFullList({ sort: "-created", filter: `created >= "${date} ${startTime}:00" && created <= "${date} ${endTime}:00" && raum = "${raum}"`});
  
            records.forEach((record) => {
              const scan = scanTemplate.content.cloneNode(true);
              scan.querySelector(".name").innerText = record.name;
              scan.querySelector(".matr_nr").innerText = record.matr_nr;
              const create_time = record.created.split(' ')[1].substring(0, 5);
              scan.querySelector(".checkin_time").innerText = create_time;
              const lesson_start_in_minutes = parseInt(lesson_start.split(':')[0], 10) * 60 + parseInt(lesson_start.split(':')[1], 10);
              const create_time_in_minutes = parseInt(create_time.split(':')[0], 10) * 60 + parseInt(create_time.split(':')[1], 10);
              scan.querySelector(".lateness").innerText = create_time_in_minutes - lesson_start_in_minutes;
              scanList.appendChild(scan);
            });
          } catch (e) {
            console.error(e);
          }
      })
      const records_scanner = await pb.collection('scanners').getFullList({fields: "raum"});
      const dropdown = document.getElementById("raum");
      records_scanner.forEach((record_scanner) => {
        const option = document.createElement("option");
        option.value = record_scanner.raum;
        option.text = record_scanner.raum;
        dropdown.appendChild(option);
      });
    </script>
  </body>
</html>
